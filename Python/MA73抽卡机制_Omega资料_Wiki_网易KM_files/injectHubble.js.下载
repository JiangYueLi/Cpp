const scriptMap = {
  test: '//kmplat.gsf.netease.com/km/test/modules/KM-front-gateway.js',
  staging: '//kmplat.gsf.netease.com/km/staging/modules/KM-front-gateway.js',
  production: '//kmplat.gsf.netease.com/km/production/modules/KM-front-gateway.js',
};

window.neteaseClickStat = window.neteaseClickStat || function () { };
window.neteaseTracker = window.neteaseTracker || function () { };

// 获取appKey
let appKey = '';
const currSrc = document.currentScript ? document.currentScript.src : '';
let urlObj = {};
try {
  urlObj = new URL(currSrc);
  appKey = urlObj.searchParams && urlObj.searchParams.get('appKey') || '';
} catch (error) {
  console.warn(error);
}

// 加载js脚本
function loadScript(scriptUrl) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    let src = scriptUrl + '?t=' + Date.now();
    if (appKey) {
      src = src + '&appKey=' + appKey;
    }
    script.src = src;
    script.onload = function () {
      console.log('script loaded');
      resolve();
    };
    // script.onerror(function () {
    //   console.log('script error');
    //   reject();
    // });
    document.head.append(script);
  });
}

let env = 'production';

// 根据域名判断环境
const businessEnv = (() => {
  const match = location.hostname.match(/\S*(test|staging)-/);
  if (match) {
    return match[1] || 'production';
  }
})();

loadScript(scriptMap[businessEnv] || scriptMap.production);
